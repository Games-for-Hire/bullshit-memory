name: Deploy

on:
  push:
    branches:
      - deployment

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository
    - name: Update Version
      run: |    
        sed s/--version--/$(git log -n 1 | head -n 1 | sed -e 's/^commit //' | head -c 8)/g prod/config.js > config.js
    - name: Setup Pages
      if: github.ref == 'refs/heads/deployment'
      uses: actions/configure-pages@v3

    - name: Upload Artifact
      if: github.ref == 'refs/heads/deployment'
      uses: actions/upload-pages-artifact@v1
      with:
        # location of the coverage artifacts
        path: "."

  deploy-coverage:
    if: github.ref == 'refs/heads/deployment'
    runs-on: ubuntu-latest
    needs: prepare
    
    permissions:
      pages: write
      id-token: write

    environment:
      # environment created automatically by GitHub
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2